// Generated by CoffeeScript 1.9.1
'use strict';
angular.module('ZooLib.controllers.room', []).controller('RoomController', function(itemRepository, $log, $scope, $stateParams, $filter, $state) {
  var TAG_MASTER, TAG_ROOM, activeItemFilter;
  console.log('state params: ', $stateParams);
  TAG_ROOM = 'room';
  TAG_MASTER = 'master';
  activeItemFilter = $filter('activeItems');
  this.groups = [];
  this.rooms = [];
  this.items = {};
  this.masterSwitches = {};
  this.getMasterSwitchFromGroup = function(group) {
    var mambers;
    if (!group) {
      return null;
    }
    mambers = group.map(function(member) {
      if (member.tags.find(TAG_MASTER)) {
        return member;
      }
    });
    if (members.length !== 1) {
      return $log.error("Group " + group.name + " has more than one member tagged as master!");
    } else {
      return members[0];
    }
  };
  this.refreshItems = function() {
    itemRepository.getAll().then((function(_this) {
      return function(data) {
        var activeItems, items, ref, room;
        data.forEach(function(item) {
          var base, groupName;
          if (item.type === 'GroupItem') {
            if (item.tags.indexOf(TAG_ROOM) >= 0) {
              return this.rooms.push(item);
            } else if (item.tags.indexOf(TAG_MASTER) >= 0) {
              return this.masterSwitches[item.name] = item;
            } else {
              return this.groups.push(item);
            }
          } else if (item.groupNames.length > 0) {
            if (item.groupNames.length > 1) {
              $log.warn("Item " + item.label + " is in multiple groups, thats not implemented", item.groupNames);
            }
            groupName = item.groupNames[0];
            if ((base = this.items)[groupName] == null) {
              base[groupName] = [];
            }
            return this.items[groupName].push(item);
          } else {
            return $log.warn('Dunno what to do with this:', item);
          }
        }, _this);
        $log.debug('groups: ', _this.groups);
        $log.debug('rooms: ', _this.rooms);
        $log.debug('items: ', _this.items);
        ref = _this.items;
        for (room in ref) {
          items = ref[room];
          activeItems = activeItemFilter(items);
          _this.items[room + 'Active'] = activeItems;
        }
        if (!$stateParams.room && _this.rooms.length > 0) {
          $log.debug("Initial redirect to room " + _this.rooms[0].name);
          return $state.go("rooms.room", {
            active: true,
            room: _this.rooms[0].name
          });
        }
      };
    })(this));
  };
  this["switch"] = function(item) {
    return $log.debug('Handle Switch Item', item);
  };
  this.switchMaster = function(room) {
    return $log.debug('Handle Master Switch Item', room);
  };
  this.initialize = function() {
    return this.refreshItems();
  };
  return this.initialize();
});
